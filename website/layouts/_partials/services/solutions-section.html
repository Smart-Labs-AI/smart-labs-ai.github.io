{{- $servicesSolutionsSection   := .Params.services_solutions_section -}}
{{- $title   := index $servicesSolutionsSection "title" -}}
{{- $subtitle    := index $servicesSolutionsSection "subtitle" -}}
{{- $buttonText   := index $servicesSolutionsSection "buttonText" -}}
{{- $features   := index $servicesSolutionsSection "features" -}}
{{ $image1 := partial "convert-image.html" (dict "src" "/services/features_background.png" "resize" "1800x" "quality" "100") }}
{{ $image2 := partial "convert-image.html" (dict "src" "/services/service-image-1.png" "resize" "1800x" "quality" "100") }}
{{ $image3 := partial "convert-image.html" (dict "src" "/services/service-image-2.png" "resize" "1800x" "quality" "100") }}
{{ $image4 := partial "convert-image.html" (dict "src" "/services/service-image-3.png" "resize" "1800x" "quality" "100") }}

<style>
.progress.is-small, .mobile-progress {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  height: 8px;
  width: 100%;
  position: relative;
  overflow: hidden;
}

.progress-value, .mobile-progress-value {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: linear-gradient(45deg, #007bff, #0056b3);
  border-radius: 4px;
  width: 0%;
  transition: width 0.5s ease;
}

.progress.is-small.animate .progress-value,
.mobile-progress.animate .mobile-progress-value {
  animation: progressFill 4.4s ease-out forwards;
}

.progress.is-small.shimmer::before,
.mobile-progress.shimmer::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: shimmer 4s infinite 0.5s;
  z-index: 2;
}

@keyframes progressFill {
  0% { width: 0%; }
  100% { width: 100%; }
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Feature Card Enhancements */
.feature-card {
  transition: all 0.3s ease;
  cursor: pointer;
  border-radius: 8px;
  padding: 1.5rem;
}

.feature-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.feature-radio:checked + .feature-card {
  border-color: #007bff;
  background-color: rgba(0, 123, 255, 0.05);
  box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
}

/* Chart Container */
.feature-chart {
  position: relative;
  overflow: hidden;
  border-radius: 12px;
  min-height: 400px;
}

/* Image Transitions */
.feature-chart-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
  opacity: 0;
  transform: scale(0.95);
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1;
}

.feature-chart-image.active {
  opacity: 1;
  transform: scale(1);
  z-index: 2;
}

.feature-chart-image:first-child {
  display: block;
}

/* Mobile Title Animation */
.mobile-feature-title {
  transition: opacity 0.3s ease;
}

/* Loading Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.feature-chart-image.active {
  animation: fadeIn 0.6s ease-out;
}
</style>

<section class="services-solutions-section">
  <div class="container">
    <div class="section-title-wrapper">
      <h2 class="section-subtitle">{{ $subtitle }}</h2>
      <h1 class="section-title">{{ $title }}</h1>
    </div>
    <div class="service">
      <div class="service-header">
        <img src="/images/logos/logo-white-simple.svg" alt="Smart Lens Logo" class="service-logo" />
        <h2 class="service-title">{{ $subtitle }}</h2>
      </div>
      <div class="features-wrapper">
        <!-- Desktop Features Container -->
        <div class="features-container">
          {{ range $index, $feature := $features }}
          <input
              type="radio"
              name="feature"
              id="feature-{{ $index }}"
              class="feature-radio"
              hidden
              {{ if eq $index 0 }}checked{{ end }}
              data-image-index="{{ $index }}"
              data-description="{{ $feature.description }}"
          >
          <label for="feature-{{ $index }}" class="feature-card">
            <div class="feature-card-content">
              <div class="feature-icon-wrapper">
                <img class="feature-icon" src="{{ $feature.icon }}"/>
              </div>
              <h3 class="feature-description">{{ $feature.description }}</h3>
            </div>
            <div class="progress is-small"><div class="progress-value"></div></div>
          </label>
          {{ end }}
        </div>
        
        <!-- Mobile Features Container -->
        <div class="features-container-mobile">
          <div class="mobile-icon-selector">
            {{ range $index, $feature := $features }}
            <input
                type="radio"
                name="feature-mobile"
                id="feature-mobile-{{ $index }}"
                class="feature-radio"
                hidden
                {{ if eq $index 0 }}checked{{ end }}
                data-image-index="{{ $index }}"
                data-description="{{ $feature.description }}"
            >
            <label for="feature-mobile-{{ $index }}" class="mobile-icon-btn">
              <img class="feature-icon" src="{{ $feature.icon }}" alt="{{ $feature.description }}"/>
            </label>
            {{ end }}
          </div>
          <div class="mobile-shared-content">
            <h3 class="mobile-feature-title" id="mobile-feature-title">
              {{ (index $features 0).description }}
            </h3>
            <div class="mobile-progress" id="mobile-progress">
              <div class="mobile-progress-value"></div>
            </div>
          </div>
        </div>
        
        <div class="feature-chart" style="background-image: url('{{ $image1.url }}');">
          <img class="feature-chart-image" src="{{ $image2.url }}" alt="Feature Image 1" data-index="0">
          <img class="feature-chart-image" src="{{ $image3.url }}" alt="Feature Image 2" data-index="1">
          <img class="feature-chart-image" src="{{ $image4.url }}" alt="Feature Image 3" data-index="2">
        </div>
      </div>
    </div>
    <a href="/contact/free-risk-check" class="button rounded secondary-btn raised mr-4 mb-4">
      {{ $buttonText }}
      <span class="icon ml-2">
        <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const wrapper = document.querySelector('.services-solutions-section .features-wrapper');
  if (!wrapper) return;
  
  const chartImages = wrapper.querySelectorAll('.feature-chart-image');
  const desktopRadios = wrapper.querySelectorAll('input[name="feature"]');
  const mobileRadios = wrapper.querySelectorAll('input[name="feature-mobile"]');
  const mobileTitle = document.getElementById('mobile-feature-title');
  const mobileProgress = document.getElementById('mobile-progress');
  
  let currentIndex = 0;
  let intervalId;
  let isManualInteraction = false;

  const animateProgress = (progressEl, isAuto = false) => {
    const progressValueEl = progressEl.querySelector('.progress-value, .mobile-progress-value');
    if (!progressValueEl) return;

    progressEl.classList.remove('animate', 'shimmer');
    progressValueEl.style.width = '0%';
    
    void progressEl.offsetHeight;
    
    if (isAuto) {
      progressEl.classList.add('animate');
      setTimeout(() => progressEl.classList.add('shimmer'), 500);
    } else {
      progressValueEl.style.width = '100%';
      setTimeout(() => progressEl.classList.add('shimmer'), 500);
    }
  };

  const applyState = (radio, isAuto = false) => {
    if (!radio) return;
    
    const imageIndex = parseInt(radio.getAttribute('data-image-index'));
    const description = radio.getAttribute('data-description');

    chartImages.forEach(img => {
      img.style.display = 'none';
      img.classList.remove('active');
    });
    
    const activeImage = chartImages[imageIndex];
    if (activeImage) {
      activeImage.style.display = 'block';
      activeImage.classList.add('active');
    }

    wrapper.querySelectorAll('.progress.is-small').forEach(p => {
      p.classList.remove('animate', 'shimmer');
      const valueEl = p.querySelector('.progress-value');
      if (valueEl) {
        valueEl.style.width = '0%';
      }
    });

    const progressEl = radio.nextElementSibling?.querySelector('.progress.is-small');
    if (progressEl) {
      setTimeout(() => animateProgress(progressEl, isAuto), 100);
    }

    if (mobileTitle && description && mobileTitle.textContent !== description) {
      mobileTitle.style.opacity = '0';
      setTimeout(() => {
        mobileTitle.textContent = description;
        mobileTitle.style.opacity = '1';
      }, 150);
    }

    if (mobileProgress) {
      mobileProgress.classList.remove('animate', 'shimmer');
      const mobileProgressValue = mobileProgress.querySelector('.mobile-progress-value');
      if (mobileProgressValue) {
        mobileProgressValue.style.width = '0%';
        void mobileProgress.offsetHeight;
        
        if (isAuto) {
          mobileProgress.classList.add('animate');
          setTimeout(() => mobileProgress.classList.add('shimmer'), 500);
        } else {
          mobileProgressValue.style.width = '100%';
          setTimeout(() => mobileProgress.classList.add('shimmer'), 500);
        }
      }
    }
  };

  const startCarousel = () => {
    if (intervalId) {
      stopCarousel();
    }
    
    const radios = window.innerWidth <= 920 ? mobileRadios : desktopRadios;
    
    intervalId = setInterval(() => {
      if (!isManualInteraction) {
        currentIndex = (currentIndex + 1) % radios.length;
        const nextRadio = radios[currentIndex];
        nextRadio.checked = true;
        applyState(nextRadio, true);
      }
    }, 5000);
  };

  const stopCarousel = () => {
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
  };

  [...desktopRadios, ...mobileRadios].forEach((radio) => {
    radio.addEventListener('change', () => {
      if (radio.checked) {
        isManualInteraction = true;
        stopCarousel();
        currentIndex = parseInt(radio.getAttribute('data-image-index'));
        applyState(radio, false);
        setTimeout(() => {
          isManualInteraction = false;
          startCarousel();
        }, 5000);
      }
    });
  });

  setTimeout(() => {
    const firstRadio = desktopRadios[0];
    if (firstRadio) {
      applyState(firstRadio, true);
      startCarousel();
    }
  }, 500);

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (!isManualInteraction) {
        stopCarousel();
        startCarousel();
      }
    }, 250);
  });
});
</script>