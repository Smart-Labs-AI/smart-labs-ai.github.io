{{/* Partial: profile-image.html
     Übergabe:
     {{ partial "profile-image.html" (dict "img" "bild.jpg" "ctx" .) }}
     ODER mit bereits verarbeitetem Bild-Objekt:
     {{ partial "profile-image.html" (dict "resource" $imgResource "ctx" .) }}
*/}}

{{ $ctx := .ctx }}
{{ $imgPath := .img }}
{{ $imgResource := .resource }}

{{/* Page-Context ermitteln */}}
{{ $page := $ctx }}
{{ if $ctx.Page }}
  {{ $page = $ctx.Page }}
{{ end }}

{{ $scratch := $page.Scratch }}

{{/* Unique ID für jedes Bild generieren */}}
{{ $uniqueId := printf "profile-%d" (now.Unix | int) }}
{{ $random := mod (now.UnixNano) 1000 }}
{{ $animDelay := printf "%.1fs" (div (mod $random 50) 10.0) }}
{{ $floatDuration := printf "%.1fs" (add 8 (div (mod $random 40) 10.0)) }}
{{ $glowDuration := printf "%.1fs" (add 6 (div (mod $random 30) 10.0)) }}

{{/* --- CSS nur 1x pro Seite laden --- */}}
{{ if not ($scratch.Get "slProfileCssAdded") }}
  {{ $scratch.Set "slProfileCssAdded" true }}
  <style>
    .sl-profile-wrapper {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 2rem auto;
      perspective: 1000px;
    }

    .sl-profile-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .sl-profile-wrapper:hover .sl-profile-inner {
      transform: scale(1.05) rotateY(5deg);
    }

    .sl-profile-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      position: relative;
      z-index: 3;
      box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.15),
        0 0 0 3px rgba(255, 255, 255, 0.1),
        inset 0 0 0 1px rgba(255, 255, 255, 0.2);
      border: 4px solid rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    /* Gradient Ring - Blau/Violett ohne Rosa */
    .sl-profile-ring {
      position: absolute;
      top: -8px;
      left: -8px;
      width: calc(100% + 16px);
      height: calc(100% + 16px);
      border-radius: 50%;
      background: linear-gradient(
        135deg,
        rgba(59, 130, 246, 0.6) 0%,
        rgba(99, 102, 241, 0.6) 50%,
        rgba(139, 92, 246, 0.6) 100%
      );
      z-index: 1;
      opacity: 0;
      filter: blur(2px);
    }

    /* Glow Effect - Blau/Violett */
    .sl-profile-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(59, 130, 246, 0.3),
        rgba(99, 102, 241, 0.2),
        rgba(139, 92, 246, 0.15),
        transparent 70%
      );
      filter: blur(30px);
      z-index: 0;
    }

    /* Shimmer Effect */
    .sl-profile-shimmer {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        120deg,
        transparent 0%,
        transparent 40%,
        rgba(255, 255, 255, 0.2) 50%,
        transparent 60%,
        transparent 100%
      );
      border-radius: 50%;
      z-index: 4;
      pointer-events: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sl-profile-wrapper {
        width: 160px;
        height: 160px;
      }
    }

  </style>
{{ end }}

{{/* --- Bild verarbeiten & anzeigen --- */}}
{{ $img := "" }}
{{ $imgUrl := "" }}

{{/* Fall 1: Resource-Objekt wurde direkt übergeben */}}
{{ if $imgResource }}
  {{ $img = $imgResource }}
  {{ $imgUrl = $imgResource.RelPermalink }}

{{/* Fall 2: Pfad wurde übergeben */}}
{{ else if $imgPath }}
  {{/* Versuche zuerst Page Resources */}}
  {{ with $page.Resources.GetMatch $imgPath }}
    {{ $img = .Fill "400x400 center" }}
    {{ $imgUrl = $img.RelPermalink }}
  {{ else }}
    {{/* Fallback: Global Resources (assets-Ordner) */}}
    {{ with resources.Get $imgPath }}
      {{ $img = .Fill "400x400 center" }}
      {{ $imgUrl = $img.RelPermalink }}
    {{ else }}
      {{/* Vielleicht ist es schon eine fertige URL? */}}
      {{ if hasPrefix $imgPath "/" }}
        {{ $imgUrl = $imgPath }}
      {{ else }}
        {{ warnf "Bild nicht gefunden: %s (Seite: %s)" $imgPath $page.RelPermalink }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $imgUrl }}
  <div class="sl-profile-wrapper">
    <div class="sl-profile-glow" style="animation: sl-glow-{{ $uniqueId }} {{ $glowDuration }} ease-in-out infinite alternate; animation-delay: {{ $animDelay }};"></div>
    <div class="sl-profile-ring" style="animation: sl-ring-pulse-{{ $uniqueId }} 12s ease-in-out infinite; animation-delay: {{ $animDelay }};"></div>
    <div class="sl-profile-dots" style="animation-delay: {{ $animDelay }};"></div>
    <div class="sl-profile-inner">
      <div class="sl-profile-shimmer" style="animation: sl-shimmer-{{ $uniqueId }} 15s linear infinite; animation-delay: {{ $animDelay }};"></div>
      <img 
        src="{{ $imgUrl }}"
        alt="Profilbild"
        class="sl-profile-image"
        loading="lazy"
        width="400"
        height="400"
        style="animation: sl-float-{{ $uniqueId }} {{ $floatDuration }} ease-in-out infinite; animation-delay: {{ $animDelay }};"
      />
    </div>
  </div>
{{ end }}