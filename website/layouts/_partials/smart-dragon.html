
<smartdragon-chat 
  webhook-url="https://n8n.infra.smart-labs.ai/webhook/5c2012cb-985d-4e65-bbc4-308999ffff93/chat"
  streaming="true"
  theme="auto"
  title="Smart Dragon"
  subtitle="Dein KI-Assistent">
</smartdragon-chat>

<div class="smart-dragon-overlay">
  <div class="smart-dragon-chat"></div>
</div>

<div class="smart-dragon-box">
  <div class="logo">
    <img src="/images/smart-dragon/smart-dragon-icon.svg" alt="Smart Dragon Logo" />
  </div>
  <div class="input">
    <textarea placeholder="Smart Dragon fragen"></textarea>
  </div>
  <div class="send-button">
    <img src="/images/smart-dragon/send-icon.svg" alt="Send Icon" />
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const smartDragonBox = document.querySelector('.smart-dragon-box');
  const input = smartDragonBox.querySelector('.input textarea');
  const sendButton = smartDragonBox.querySelector('.send-button');
  const overlay = document.querySelector('.smart-dragon-overlay');
  const chatContainer = document.querySelector('.smart-dragon-chat');
  
  // Stage variable: 1 = collapsed, 2 = expanded, 3 = overlay/chat
  let stage = 1;
  
  function enterStage2() {
    stage = 2;
    smartDragonBox.classList.add('expanded');
    
    // Wenn bereits Text eingegeben wurde, direkt zu Stage 3
    if (input.value.trim() !== '') {
      enterStage3();
    } else {
      input.focus();
    }
  }
  
  function enterStage3() {
    stage = 3;
    smartDragonBox.classList.add('expanded');
    overlay.classList.add('active');
    
    // Sample conversation (only on first open)
    if (chatContainer.innerHTML === '') {
      const messages = [
        { type: 'user', text: 'Hallo, das ist Test von "Ask Smart Dragon" auf der Smart Labs AI Website.' },
        { type: 'ai', text: "Hallo, herzlich Willkommen bei Smart Labs AI! Der Test war erfolgreich!\nWie kann ich dir behilflich sein? ðŸ˜Š" },
        { type: 'user', text: "Alles gut, das war's schon. Wollte es nur mal testen. Danke!" },
        { type: 'ai', text: "Sehr gerne! Wenn du mit dem Test zufrieden warst, empfehle ich Dir Smart Dragon gerne auch fÃ¼r Dein Unternehmen. Mehr Informationen findest du auch auf unserer Produktseite." }
      ];
      
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('smart-dragon-message', msg.type);
        div.textContent = msg.text;
        chatContainer.appendChild(div);
      });
    }
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
    input.focus();
  }
  
  function sendMessage() {
    const text = input.value.trim();
    
    if (text === '') return; // Keine leeren Nachrichten senden
    
    // Nachricht zur Chat-Ansicht hinzufÃ¼gen
    const userMsg = document.createElement('div');
    userMsg.classList.add('smart-dragon-message', 'user');
    userMsg.textContent = text;
    chatContainer.appendChild(userMsg);
    
    // Textarea leeren
    input.value = '';
    
    // Zur Stage 3 wechseln (falls noch nicht)
    if (stage !== 3) {
      enterStage3();
    }
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Optional: Hier kÃ¶nntest du eine AI-Antwort simulieren
    // setTimeout(() => {
    //   const aiMsg = document.createElement('div');
    //   aiMsg.classList.add('smart-dragon-message', 'ai');
    //   aiMsg.textContent = 'Das ist eine automatische Antwort...';
    //   chatContainer.appendChild(aiMsg);
    //   chatContainer.scrollTop = chatContainer.scrollHeight;
    // }, 500);
  }
  
  function enterStage1() {
    stage = 1;
    smartDragonBox.classList.remove('expanded');
    overlay.classList.remove('active');
    input.blur(); // Fokus entfernen
  }
  
  // Click chat box â†’ enter stage 2 if currently collapsed
  smartDragonBox.addEventListener('click', function(e) {
    if (stage === 1) {
      // Wenn Text vorhanden ist, direkt zu Stage 3
      if (chatContainer.innerHTML !== '') {
        enterStage3();
      } else {
        enterStage2();
      }
    }
    e.stopPropagation();
  });
  
  // Click outside â†’ collapse if stage 2
  document.addEventListener('click', function(e) {
    if (!smartDragonBox.contains(e.target) && stage === 2) {
      enterStage1();
    }
  });
  
  // Send button â†’ send message
  sendButton.addEventListener('click', function(e) {
    e.stopPropagation();
    sendMessage();
  });
  
  // Overlay click â†’ return to stage 2
  overlay.addEventListener('click', function() {
    enterStage2();
  });
  
  // Escape key â†’ always return to stage 1
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      enterStage1();
    }
  });
  
  // Handle Enter / Shift+Enter in textarea
  input.addEventListener('keydown', function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
});
</script>