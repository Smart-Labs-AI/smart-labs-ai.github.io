{{- $servicesSolutionsSection   := .Params.services_solutions_section }}
{{- $title   := index $servicesSolutionsSection "title" }}
{{- $subtitle    := index $servicesSolutionsSection "subtitle" }}
{{- $buttonText   := index $servicesSolutionsSection "buttonText" }}
{{- $features   := index $servicesSolutionsSection "features" }}

{{ $src1 := "/services/features_background.png" }}
{{ $src2 := "/services/service-image-1.png" }}
{{ $src3 := "/services/service-image-2.png" }}
{{ $src4 := "/services/service-image-3.png" }}

{{ $img1 := resources.Get $src1 }}
{{ $img2 := resources.Get $src2 }}
{{ $img3 := resources.Get $src3 }}
{{ $img4 := resources.Get $src4 }}

{{ if and $img1 $img2 $img3 $img4 }}
{{ $processed1 := $img1.Process "resize 1800x webp q100" }}
{{ $processed2 := $img2.Process "resize 1800x webp q100" }}
{{ $processed3 := $img3.Process "resize 1800x webp q100" }}
{{ $processed4 := $img4.Process "resize 1800x webp q100" }}

<section class="services-solutions-section">
  <div class="container">
    <div class="section-title-wrapper">
      <h2 class="section-subtitle">{{ $subtitle }}</h2>
      <h1 class="section-title">{{ $title }}</h1>
    </div>

    <div class="service">
      <div class="service-header">
        <img src="/images/logos/logo-white-simple.svg" alt="Smart Lens Logo" class="service-logo" />
        <h2 class="service-title">{{ $subtitle }}</h2>
      </div>

      <div class="features-wrapper">
        <!-- Desktop Features Container -->
        <div class="features-container">
          {{ range $index, $feature := $features }}
          <input
              type="radio"
              name="feature"
              id="feature-{{ $index }}"
              class="feature-radio"
              hidden
              {{ if eq $index 0 }}checked{{ end }}
              data-chart-img="{{ if eq $index 0 }}{{ $processed2.RelPermalink }}{{ else if eq $index 1 }}{{ $processed3.RelPermalink }}{{ else if eq $index 2 }}{{ $processed4.RelPermalink }}{{ else }}{{ $processed2.RelPermalink }}{{ end }}"
              data-progress="{{ if eq $index 0 }}33.33{{ else if eq $index 1 }}66.66{{ else if eq $index 2 }}100{{ else }}0{{ end }}"
              data-description="{{ $feature.description }}"
          >
          <label for="feature-{{ $index }}" class="feature-card">
            <div class="feature-card-content">
              <div class="feature-icon-wrapper">
                <img class="feature-icon" src="{{ $feature.icon }}"/>
              </div>
              <h3 class="feature-description">{{ $feature.description }}</h3>
            </div>
            <progress class="progress is-small" value="0" max="100"></progress>
          </label>
          {{ end }}
        </div>

        <!-- Mobile Features Container -->
        <div class="features-container-mobile">
          <div class="mobile-icon-selector">
            {{ range $index, $feature := $features }}
            <input
                type="radio"
                name="feature-mobile"
                id="feature-mobile-{{ $index }}"
                class="feature-radio"
                hidden
                {{ if eq $index 0 }}checked{{ end }}
                data-chart-img="{{ if eq $index 0 }}{{ $processed2.RelPermalink }}{{ else if eq $index 1 }}{{ $processed3.RelPermalink }}{{ else if eq $index 2 }}{{ $processed4.RelPermalink }}{{ else }}{{ $processed2.RelPermalink }}{{ end }}"
                data-progress="{{ if eq $index 0 }}33.33{{ else if eq $index 1 }}66.66{{ else if eq $index 2 }}100{{ else }}0{{ end }}"
                data-description="{{ $feature.description }}"
            >
            <label for="feature-mobile-{{ $index }}" class="mobile-icon-btn">
              <img class="feature-icon" src="{{ $feature.icon }}" alt="{{ $feature.description }}"/>
            </label>
            {{ end }}
          </div>

          <div class="mobile-shared-content">
            <h3 class="mobile-feature-title" id="mobile-feature-title">
              {{ (index $features 0).description }}
            </h3>
            <progress class="mobile-progress" id="mobile-progress" value="33.33" max="100"></progress>
          </div>
        </div>

        <div class="feature-chart" style="background-image: url('{{ $processed1.RelPermalink }}');">
          <img id="feature-img-0" class="feature-chart-image" src="{{ $processed2.RelPermalink }}" alt="Feature Image">
          <img id="feature-img-1" class="feature-chart-image" src="{{ $processed3.RelPermalink }}" alt="Feature Image" style="display: none;">
          <img id="feature-img-2" class="feature-chart-image" src="{{ $processed4.RelPermalink }}" alt="Feature Image" style="display: none;">
        </div>
      </div>
    </div>

    <a href="/contact/free-risk-check" class="button rounded secondary-btn raised mr-4 mb-4">
      {{ $buttonText }}
      <span class="icon ml-2">
        <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const wrapper = document.querySelector('.services-solutions-section .features-wrapper');
    if (!wrapper) return;

    const chartImages = wrapper.querySelectorAll('.feature-chart .feature-chart-image');
    const desktopRadios = wrapper.querySelectorAll('input[name="feature"]');
    const mobileRadios = wrapper.querySelectorAll('input[name="feature-mobile"]');
    const mobileTitle = document.getElementById('mobile-feature-title');
    const mobileProgress = document.getElementById('mobile-progress');

    let currentIndex = 0;
    let intervalId;
    let animationFrameId;

    const animateProgress = (progressEl, duration) => {
      let start = null;
      const step = (timestamp) => {
        if (!start) start = timestamp;
        const progress = Math.min((timestamp - start) / duration, 1);
        progressEl.value = progress * 100;
        if (progress < 1) {
          animationFrameId = requestAnimationFrame(step);
        }
      };
      animationFrameId = requestAnimationFrame(step);
    };

    const applyState = (radio, isAuto) => {
      if (!radio) return;
      const imgId = radio.getAttribute('data-chart-img');
      const progressValue = radio.getAttribute('data-progress');
      const description = radio.getAttribute('data-description');

      chartImages.forEach(img => img.style.display = 'none');
      const activeImage = document.getElementById(imgId);
      if (activeImage) {
        activeImage.style.display = 'block';
      }

      const progressBars = wrapper.querySelectorAll('.progress');
      progressBars.forEach(p => p.value = 0);
      cancelAnimationFrame(animationFrameId);

      const progressEl = radio.nextElementSibling?.querySelector('.progress');

      if (isAuto && progressEl) {
        animateProgress(progressEl, 2900);
      } else if (progressEl && progressValue) {
        progressEl.value = progressValue;
      }

      if (mobileTitle && description) {
        mobileTitle.style.opacity = '0';
        setTimeout(() => {
          mobileTitle.textContent = description;
          mobileTitle.style.opacity = '1';
        }, 150);
      }

      if (mobileProgress && progressValue) {
        mobileProgress.value = progressValue;
      }
    };

    const startCarousel = () => {
      const radios = window.innerWidth <= 920 ? mobileRadios : desktopRadios;
      applyState(radios[currentIndex], true);
      intervalId = setInterval(() => {
        currentIndex = (currentIndex + 1) % radios.length;
        const nextRadio = radios[currentIndex];
        nextRadio.checked = true;
        applyState(nextRadio, true);
      }, 3500);
    };

    const stopCarousel = () => {
      clearInterval(intervalId);
      cancelAnimationFrame(animationFrameId);
    };

    const initialDesktop = wrapper.querySelector('input[name="feature"]:checked') || desktopRadios[0];
    const initialMobile = wrapper.querySelector('input[name="feature-mobile"]:checked') || mobileRadios[0];

    if (initialDesktop) applyState(initialDesktop, false);
    if (initialMobile && window.innerWidth <= 920) applyState(initialMobile, false);

    desktopRadios.forEach((r, index) => {
      r.setAttribute('data-chart-img', 'feature-img-' + index);
      r.addEventListener('change', () => {
        if (r.checked) {
          stopCarousel();
          currentIndex = index;
          applyState(r, false);
          setTimeout(startCarousel, 3500);
        }
      });
    });

    mobileRadios.forEach((r, index) => {
      r.setAttribute('data-chart-img', 'feature-img-' + index);
      r.addEventListener('change', () => {
        if (r.checked) {
          stopCarousel();
          currentIndex = index;
          applyState(r, false);
          setTimeout(startCarousel, 3500);
        }
      });
    });

    window.addEventListener('resize', () => {
      const isMobile = window.innerWidth <= 920;
      const activeDesktop = wrapper.querySelector('input[name="feature"]:checked');
      const activeMobile = wrapper.querySelector('input[name="feature-mobile"]:checked');

      if (isMobile && activeMobile) {
        applyState(activeMobile, false);
      } else if (!isMobile && activeDesktop) {
        applyState(activeDesktop, false);
      }
      stopCarousel();
      startCarousel();
    });

    startCarousel();
  });
</script>
{{ else }}
  {{ errorf "One or more images not found" }}
{{ end }}